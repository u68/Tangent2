;; Compile Options : /TML620909 /ML /near /SD /Oa /Ot /W 1 /Fasrc\ 
;; Version Number  : Ver.3.66.2
;; File Name       : vm.c

	type (ML620909) 
	model large, near
	$$TABerror$vm segment table 2h #0h
	$$TABmsg$vm segment table 2h #0h
	$$init_prog$vm segment code 2h any
	$$invalid_instruction$vm segment code 2h any
	$$load_from_rom$vm segment code 2h any
	$$memcpy$vm segment code 2h any
CVERSION 3.66.2
CGLOBAL 01H 03H 0000H "invalid_instruction" 08H 02H 01H 00H 81H 08H 00H 00H 07H
CGLOBAL 01H 03H 0000H "memcpy" 08H 02H 00H 00H 82H 08H 00H 00H 07H
CGLOBAL 01H 03H 0000H "init_prog" 08H 02H 02H 00H 80H 00H 00H 00H 07H
CGLOBAL 01H 03H 0000H "load_from_rom" 08H 02H 04H 00H 80H 04H 00H 00H 07H
CENUMTAG 0000H 0000H 0001H 0017H "SPECIAL_CHARS"
CENUMMEM 0000000AH "SP_EXE"
CENUMMEM 00000009H "SP_TAB"
CENUMMEM 00000020H "SP_SPACE"
CENUMMEM 00000008H "SP_BACKSPACE"
CENUMMEM 0000002AH "SP_HOME"
CENUMMEM 0000001AH "SP_END"
CENUMMEM 0000003AH "SP_YES"
CENUMMEM 00000012H "SP_NO"
CENUMMEM 00000021H "SP_OK"
CENUMMEM 00000020H "SP_UP"
CENUMMEM 00000022H "SP_DOWN"
CENUMMEM 00000029H "SP_LEFT"
CENUMMEM 00000019H "SP_RIGHT"
CENUMMEM 00000010H "SP_PLUS"
CENUMMEM 00000011H "SP_MINUS"
CENUMMEM 00000031H "SP_ALT"
CENUMMEM 00000030H "SP_ABC"
CENUMMEM 00000039H "SP_ESC"
CENUMMEM 0000003AH "SP_SELECTLEFT"
CENUMMEM 0000003BH "SP_SELECTRIGHT"
CENUMMEM 0000003CH "SP_PASTE"
CENUMMEM 0000003DH "SP_COPY"
CENUMMEM 0000003EH "SPECIAL_MAX"
CENUMTAG 0000H 0000H 0000H 0025H "BUTTON"
CENUMMEM 0000000BH "B_0"
CENUMMEM 0000003FH "B_1"
CENUMMEM 00000037H "B_2"
CENUMMEM 0000002FH "B_3"
CENUMMEM 0000003EH "B_4"
CENUMMEM 00000036H "B_5"
CENUMMEM 0000002EH "B_6"
CENUMMEM 0000003DH "B_7"
CENUMMEM 00000035H "B_8"
CENUMMEM 0000002DH "B_9"
CENUMMEM 0000003CH "B_A"
CENUMMEM 00000034H "B_B"
CENUMMEM 0000002CH "B_C"
CENUMMEM 00000024H "B_D"
CENUMMEM 0000001CH "B_E"
CENUMMEM 00000014H "B_F"
CENUMMEM 0000003DH "B_G"
CENUMMEM 00000035H "B_H"
CENUMMEM 0000002DH "B_I"
CENUMMEM 00000025H "B_J"
CENUMMEM 0000001DH "B_K"
CENUMMEM 0000003EH "B_L"
CENUMMEM 00000036H "B_M"
CENUMMEM 0000002EH "B_N"
CENUMMEM 00000026H "B_O"
CENUMMEM 0000001EH "B_P"
CENUMMEM 0000003FH "B_Q"
CENUMMEM 00000037H "B_R"
CENUMMEM 0000002FH "B_S"
CENUMMEM 00000027H "B_T"
CENUMMEM 0000001FH "B_U"
CENUMMEM 0000000BH "B_V"
CENUMMEM 0000000CH "B_W"
CENUMMEM 0000000DH "B_X"
CENUMMEM 0000000EH "B_Y"
CENUMMEM 0000000FH "B_Z"
CENUMMEM 00000040H "BUTTON_COUNT"
CTYPEDEF 0000H 0000H 42H "ushort" 02H 00H 08H
CTYPEDEF 0000H 0000H 42H "byte" 02H 00H 00H
CTYPEDEF 0000H 0000H 42H "word" 02H 00H 08H
CGLOBAL 01H 00H 000DH "msg" 05H 01H 0DH 00H 00H 00H
CGLOBAL 01H 00H 0015H "error" 05H 01H 15H 00H 00H 00H
CFILE 0001H 00000070H "..\\src\\base.h"
CFILE 0002H 00000014H "..\\src\\vm.h"
CFILE 0003H 00000072H "..\\src\\io.h"
CFILE 0004H 00000008H "..\\src\\vm_config.h"
CFILE 0000H 0000002CH "..\\src\\vm.c"

	rseg $$invalid_instruction$vm
CFUNCTION 1

_invalid_instruction	:
CBLOCK 1 1 11

;;{
CLINEA 0000H 0001H 000BH 0001H 0001H
	push	lr
	push	er8
	mov	er8,	er0
CBLOCK 1 2 11
CRET 0002H
CARGUMENT 46H 0002H 0028H "opc" 02H 00H 01H

;;    print(error, 1, 1, 2);
CLINEA 0000H 0001H 000CH 0005H 001AH
	mov	r0,	#02h
	push	r0
	mov	r3,	#01h
	mov	r2,	#01h
	mov	r0,	#BYTE1 OFFSET _error
	mov	r1,	#BYTE2 OFFSET _error
	bl	_print
	add	sp,	#2 

;;    print(msg, 1, 2, 2);
CLINEA 0000H 0001H 000DH 0005H 0018H
	mov	r0,	#02h
	push	r0
	mov	r3,	#02h
	mov	r2,	#01h
	mov	r0,	#BYTE1 OFFSET _msg
	mov	r1,	#BYTE2 OFFSET _msg
	bl	_print
	add	sp,	#2 

;;    derefw(0x9000) = opc;
CLINEA 0000H 0001H 000EH 0005H 0019H
	st	er8,	09000h
CBLOCKEND 1 2 15

;;}
CLINEA 0000H 0001H 000FH 0001H 0001H
	pop	er8
	pop	pc
CBLOCKEND 1 1 15
CFUNCTIONEND 1


	rseg $$memcpy$vm
CFUNCTION 0

_memcpy	:
CBLOCK 0 1 18

;;{
CLINEA 0000H 0001H 0012H 0001H 0001H
	push	fp
	mov	fp,	sp
	push	xr8
	push	er4
	mov	er10,	er2
	mov	er8,	er0
CBLOCK 0 2 18
CARGUMENT 46H 0002H 0028H "dest" 02H 00H 01H
CARGUMENT 46H 0002H 0029H "src" 02H 00H 01H
CARGUMENT 42H 0002H 0002H "size" 02H 00H 01H
CLOCAL 46H 0002H 0026H 0002H "i" 02H 00H 08H

;;    for(i = 0;i < size;i++)
CLINEA 0000H 0001H 0014H 0005H 001BH
	mov	er4,	#0 
	bal	_$L9
_$L6 :
CBLOCK 0 3 21

;;        deref(dest+i) = deref(src+i);
CLINEA 0000H 0001H 0016H 0009H 0025H
	mov	er0,	er10
	add	er0,	er4
	mov	er2,	er0
	mov	er0,	er8
	add	er0,	er4
	l	r2,	[er2]
	st	r2,	[er0]
CBLOCKEND 0 3 23

;;    for(i = 0;i < size;i++)
CLINEA 0000H 0000H 0014H 0005H 001BH
	add	er4,	#1 
_$L9 :
	l	er2,	2[fp]
	cmp	er4,	er2
	blt	_$L6
CBLOCKEND 0 2 24

;;}
CLINEA 0000H 0001H 0018H 0001H 0001H
	pop	er4
	pop	xr8
	mov	sp,	fp
	pop	fp
	rt
CBLOCKEND 0 1 24
CFUNCTIONEND 0


	rseg $$init_prog$vm
CFUNCTION 2

_init_prog	:
CBLOCK 2 1 27

;;}
CLINEA 0000H 0001H 001DH 0001H 0001H
	rt
CBLOCKEND 2 1 29
CFUNCTIONEND 2


	rseg $$load_from_rom$vm
CFUNCTION 4

_load_from_rom	:
CBLOCK 4 1 32

;;{
CLINEA 0000H 0001H 0020H 0001H 0001H
	push	er8
	push	er4
	mov	er8,	er0
CBLOCK 4 2 32
CARGUMENT 46H 0002H 0028H "adr" 02H 00H 01H
CLOCAL 46H 0001H 0016H 0002H "i" 02H 00H 00H
CLOCAL 46H 0002H 0026H 0002H "dadr" 02H 00H 08H

;;    byte i = 0;
CLINEA 0000H 0001H 0023H 0005H 000FH
	mov	r2,	#00h

;;    word dadr = derefw(adr);
CLINEA 0000H 0001H 0024H 0005H 001CH
	l	er0,	[er8]
	mov	er4,	er0

;;    while(derefw(MAXIMUS_PROGRAMUS_START + (i * 2))) (i++);
CLINEA 0000H 0001H 0025H 0005H 003BH
	bal	_$L12
_$L14 :
	add	r2,	#01h
_$L12 :
	mov	r0,	r2
	mov	r1,	#00h
	add	er0,	er0
	l	er0,	09c00h[er0]
	bne	_$L14

;;    derefw(MAXIMUS_PROGRAMUS_START + (i * 2)) = dadr;
CLINEA 0000H 0001H 0026H 0005H 0035H
	mov	r0,	r2
	mov	r1,	#00h
	add	er0,	er0
	st	er4,	09c00h[er0]
CBLOCKEND 4 2 39

;;}
CLINEA 0000H 0001H 0027H 0001H 0001H
	pop	er4
	pop	er8
	rt
CBLOCKEND 4 1 39
CFUNCTIONEND 4

	public _msg
	public _error
	public _invalid_instruction
	public _memcpy
	public _init_prog
	public _load_from_rom
	extrn code far : _print
	extrn code far : _main

	rseg $$TABerror$vm
_error :
	DB	"twin smth aint right", 00H

	rseg $$TABmsg$vm
_msg :
	DB	"check 0x9000", 00H

	end
